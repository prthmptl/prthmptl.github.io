---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import ProjectCard from "../../../components/ProjectCard.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  const tags = [...new Set(projects.flatMap((project) => project.data.tech || []))];

  return tags.map((tag) => ({
    params: { tag: tag.toLowerCase() },
    props: {
      tag,
      projects: projects.filter((project) =>
        project.data.tech?.map((t) => t.toLowerCase()).includes(tag.toLowerCase())
      ),
    },
  }));
}

const { tag, projects } = Astro.props;
const sortedProjects = projects.sort((a, b) => {
  if (a.data.featured && !b.data.featured) return -1;
  if (!a.data.featured && b.data.featured) return 1;
  return 0;
});
---

<BaseLayout title={`Projects using "${tag}"`} description={`All projects using ${tag}`}>
  <section class="max-w-6xl mx-auto px-4 py-16">
    <div class="mb-8">
      <a href="/projects" class="text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 font-medium">
        &larr; All projects
      </a>
    </div>
    <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-4">
      Projects using <span class="text-primary-600 dark:text-primary-400">"{tag}"</span>
    </h1>
    <p class="text-xl text-gray-600 dark:text-gray-400 mb-12">
      {sortedProjects.length} project{sortedProjects.length !== 1 ? "s" : ""} found
    </p>

    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
      {sortedProjects.map((project) => (
        <ProjectCard
          title={project.data.title}
          description={project.data.description}
          tech={project.data.tech}
          slug={project.slug}
          featured={project.data.featured}
          image={project.data.image}
        />
      ))}
    </div>
  </section>
</BaseLayout>
